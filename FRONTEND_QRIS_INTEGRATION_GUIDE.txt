# Frontend QRIS Payment Integration Guide
# Complete implementation for Indonesian QRIS payments

## üöÄ OVERVIEW
Transform your current "Complete Booking" button into a full QRIS payment flow:
Current: Guest clicks "Book" ‚Üí Booking created (pending)
New: Guest clicks "Book" ‚Üí Payment page ‚Üí QR code ‚Üí Payment ‚Üí Booking confirmed

NOTE: All interface text is in English for testing. Add Bahasa Indonesia translations later.

## üìÅ FILE STRUCTURE TO CREATE/MODIFY

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ booking/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BookingFlow.jsx (modify existing)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PaymentPage.jsx (new)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QRISPayment.jsx (new)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PaymentSuccess.jsx (new)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ qrisPayment.js (new)
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ qrCodeDisplay.js (new)
```

## üîß STEP 1: UPDATE BOOKING SERVICE

### File: src/services/bookingService.js (modify existing)
```javascript
// Add this to your existing booking service

// Create booking (existing - keep as is)
export const createBooking = async (bookingData, authToken) => {
  // Your existing createBooking code here
  // This should return booking with id and status 'pending'
};

// NEW: Create QRIS payment after booking
export const createQRISPayment = async (bookingId, customerData, authToken) => {
  try {
    const response = await fetch(`${API_BASE_URL}/api/qris/qris/create`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({
        booking_id: bookingId,
        customer_name: customerData.name,
        customer_email: customerData.email
      })
    });

    if (!response.ok) {
      throw new Error('Failed to create QRIS payment');
    }

    return await response.json();
  } catch (error) {
    console.error('QRIS payment creation failed:', error);
    throw error;
  }
};

// NEW: Check payment status
export const checkPaymentStatus = async (bookingId, authToken) => {
  try {
    const response = await fetch(`${API_BASE_URL}/api/qris/qris/status/${bookingId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });

    if (!response.ok) {
      throw new Error('Failed to check payment status');
    }

    return await response.json();
  } catch (error) {
    console.error('Payment status check failed:', error);
    throw error;
  }
};

// NEW: Simulate payment (for testing only)
export const simulatePayment = async (bookingId) => {
  try {
    const response = await fetch(`${API_BASE_URL}/api/qris/qris/simulate/${bookingId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('Failed to simulate payment');
    }

    return await response.json();
  } catch (error) {
    console.error('Payment simulation failed:', error);
    throw error;
  }
};
```

## üîß STEP 2: MAIN BOOKING FLOW COMPONENT

### File: src/components/booking/BookingFlow.jsx (modify existing)
```jsx
import React, { useState } from 'react';
import { createBooking, createQRISPayment } from '../../services/bookingService';
import PaymentPage from './PaymentPage';
import PaymentSuccess from './PaymentSuccess';

const BookingFlow = ({ roomData, homestayData }) => {
  const [currentStep, setCurrentStep] = useState('booking'); // 'booking', 'payment', 'success'
  const [bookingData, setBookingData] = useState(null);
  const [paymentData, setPaymentData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Your existing booking form state here
  const [bookingForm, setBookingForm] = useState({
    start_date: '',
    end_date: '',
    number_of_guests: 1,
    customer_name: '',
    customer_email: '',
    customer_phone: '',
    special_requests: ''
  });

  // MODIFY YOUR EXISTING SUBMIT HANDLER
  const handleBookingSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      // Step 1: Create booking (your existing logic)
      const booking = await createBooking({
        ...bookingForm,
        room_id: roomData.id
      }, getAuthToken());

      setBookingData(booking.data);

      // Step 2: Create QRIS payment
      const payment = await createQRISPayment(
        booking.data.id,
        {
          name: bookingForm.customer_name,
          email: bookingForm.customer_email
        },
        getAuthToken()
      );

      setPaymentData(payment.data);
      setCurrentStep('payment'); // Move to payment step

    } catch (error) {
      console.error('Booking creation failed:', error);
      setError('Failed to create booking. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  const handlePaymentSuccess = () => {
    setCurrentStep('success');
  };

  // Get auth token (implement based on your auth system)
  const getAuthToken = () => {
    return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
  };

  return (
    <div className="booking-flow-container">
      {currentStep === 'booking' && (
        <div className="booking-form">
          <h2>Booking Homestay</h2>
          
          {/* Your existing booking form */}
          <form onSubmit={handleBookingSubmit}>
            {/* Room and homestay details */}
            <div className="booking-details">
              <h3>{homestayData.title}</h3>
              <p>{roomData.title} - Rp {roomData.price?.toLocaleString('id-ID')}/malam</p>
            </div>

            {/* Form fields (your existing fields) */}
            <div className="form-group">
              <label>Check-in Date:</label>
              <input 
                type="date" 
                value={bookingForm.start_date}
                onChange={(e) => setBookingForm({...bookingForm, start_date: e.target.value})}
                required
              />
            </div>

            <div className="form-group">
              <label>Check-out Date:</label>
              <input 
                type="date" 
                value={bookingForm.end_date}
                onChange={(e) => setBookingForm({...bookingForm, end_date: e.target.value})}
                required
              />
            </div>

            <div className="form-group">
              <label>Number of Guests:</label>
              <input 
                type="number" 
                value={bookingForm.number_of_guests}
                onChange={(e) => setBookingForm({...bookingForm, number_of_guests: parseInt(e.target.value)})}
                min="1"
                required
              />
            </div>

            <div className="form-group">
              <label>Full Name:</label>
              <input 
                type="text" 
                value={bookingForm.customer_name}
                onChange={(e) => setBookingForm({...bookingForm, customer_name: e.target.value})}
                required
              />
            </div>

            <div className="form-group">
              <label>Email:</label>
              <input 
                type="email" 
                value={bookingForm.customer_email}
                onChange={(e) => setBookingForm({...bookingForm, customer_email: e.target.value})}
                required
              />
            </div>

            <div className="form-group">
              <label>WhatsApp Number:</label>
              <input 
                type="tel" 
                value={bookingForm.customer_phone}
                onChange={(e) => setBookingForm({...bookingForm, customer_phone: e.target.value})}
                placeholder="+62812345678"
                required
              />
            </div>

            <div className="form-group">
              <label>Special Requests (Optional):</label>
              <textarea 
                value={bookingForm.special_requests}
                onChange={(e) => setBookingForm({...bookingForm, special_requests: e.target.value})}
                rows="3"
              />
            </div>

            {error && (
              <div className="error-message">
                {error}
              </div>
            )}

            {/* UPDATED SUBMIT BUTTON */}
            <button 
              type="submit" 
              className="btn-primary booking-submit-btn"
              disabled={loading}
            >
              {loading ? 'Processing...' : 'Continue to Payment'}
            </button>
          </form>
        </div>
      )}

      {currentStep === 'payment' && paymentData && (
        <PaymentPage 
          bookingData={bookingData}
          paymentData={paymentData}
          onPaymentSuccess={handlePaymentSuccess}
          onBack={() => setCurrentStep('booking')}
        />
      )}

      {currentStep === 'success' && (
        <PaymentSuccess 
          bookingData={bookingData}
          onNewBooking={() => {
            setCurrentStep('booking');
            setBookingData(null);
            setPaymentData(null);
            setBookingForm({
              start_date: '',
              end_date: '',
              number_of_guests: 1,
              customer_name: '',
              customer_email: '',
              customer_phone: '',
              special_requests: ''
            });
          }}
        />
      )}
    </div>
  );
};

export default BookingFlow;
```

## üîß STEP 3: PAYMENT PAGE COMPONENT

### File: src/components/booking/PaymentPage.jsx (new)
```jsx
import React, { useState, useEffect } from 'react';
import QRISPayment from './QRISPayment';
import { checkPaymentStatus } from '../../services/bookingService';

const PaymentPage = ({ bookingData, paymentData, onPaymentSuccess, onBack }) => {
  const [paymentStatus, setPaymentStatus] = useState('pending');
  const [loading, setLoading] = useState(false);
  const [timeLeft, setTimeLeft] = useState(null);

  // Calculate time left for payment
  useEffect(() => {
    if (paymentData.expires_at) {
      const expiryTime = new Date(paymentData.expires_at);
      const interval = setInterval(() => {
        const now = new Date();
        const diff = expiryTime - now;
        
        if (diff <= 0) {
          setTimeLeft(null);
          clearInterval(interval);
        } else {
          const minutes = Math.floor(diff / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          setTimeLeft(`${minutes}:${seconds.toString().padStart(2, '0')}`);
        }
      }, 1000);

      return () => clearInterval(interval);
    }
  }, [paymentData.expires_at]);

  // Check payment status periodically
  useEffect(() => {
    const statusInterval = setInterval(async () => {
      try {
        const status = await checkPaymentStatus(
          bookingData.id, 
          localStorage.getItem('authToken')
        );
        
        if (status.data.payment_status === 'COMPLETED') {
          setPaymentStatus('completed');
          clearInterval(statusInterval);
          setTimeout(() => onPaymentSuccess(), 2000);
        }
      } catch (error) {
        console.error('Error checking payment status:', error);
      }
    }, 3000); // Check every 3 seconds

    return () => clearInterval(statusInterval);
  }, [bookingData.id, onPaymentSuccess]);

  return (
    <div className="payment-page">
      <div className="payment-header">
        <button onClick={onBack} className="back-button">
          ‚Üê Back
        </button>
        <h2>Payment</h2>
      </div>

      <div className="payment-content">
        {/* Booking Summary */}
        <div className="booking-summary">
          <h3>Booking Details</h3>
          <div className="summary-item">
            <span>Booking Number:</span>
            <span>{bookingData.booking_number}</span>
          </div>
          <div className="summary-item">
            <span>Total Payment:</span>
            <span className="total-amount">
              Rp {paymentData.amount?.toLocaleString('id-ID')}
            </span>
          </div>
          {timeLeft && (
            <div className="payment-timer">
              <span>‚è∞ Time remaining: {timeLeft}</span>
            </div>
          )}
        </div>

        {/* Payment Status */}
        <div className="payment-status">
          {paymentStatus === 'pending' && (
            <div className="status-pending">
              <span className="status-icon">‚è≥</span>
              <span>Waiting for Payment</span>
            </div>
          )}
          
          {paymentStatus === 'completed' && (
            <div className="status-completed">
              <span className="status-icon">‚úÖ</span>
              <span>Payment Successful!</span>
            </div>
          )}
        </div>

        {/* QRIS Payment Component */}
        {paymentStatus === 'pending' && (
          <QRISPayment 
            paymentData={paymentData}
            bookingData={bookingData}
            onPaymentComplete={() => setPaymentStatus('completed')}
          />
        )}

        {/* Test Mode Notice */}
        {paymentData.is_test_mode && (
          <div className="test-mode-notice">
            <p>üß™ Test Mode - Use simulation button for testing</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default PaymentPage;
```

## üîß STEP 4: QRIS PAYMENT COMPONENT

### File: src/components/booking/QRISPayment.jsx (new)
```jsx
import React, { useState } from 'react';
import { simulatePayment } from '../../services/bookingService';

const QRISPayment = ({ paymentData, bookingData, onPaymentComplete }) => {
  const [showQR, setShowQR] = useState(false);
  const [simulating, setSimulating] = useState(false);

  // Convert QR string to displayable format
  const generateQRCodeURL = (qrString) => {
    // Using QR Server API for display
    return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrString)}`;
  };

  const handleSimulatePayment = async () => {
    if (!paymentData.is_test_mode) return;
    
    setSimulating(true);
    try {
      await simulatePayment(bookingData.id);
      onPaymentComplete();
    } catch (error) {
      console.error('Payment simulation failed:', error);
      alert('Simulasi pembayaran gagal');
    } finally {
      setSimulating(false);
    }
  };

  return (
    <div className="qris-payment">
      <div className="qris-header">
        <h3>QRIS Payment</h3>
        <p>Scan QR code with your mobile banking or e-wallet app</p>
      </div>

      <div className="qris-content">
        {!showQR ? (
          <div className="qris-start">
            <div className="payment-methods">
              <h4>Supported Payment Methods:</h4>
              <div className="method-icons">
                <span className="method">üè¶ Mobile Banking</span>
                <span className="method">üí≥ E-wallet (OVO, DANA, GoPay)</span>
                <span className="method">üì± QRIS Scanner</span>
              </div>
            </div>
            
            <button 
              className="btn-primary show-qr-btn"
              onClick={() => setShowQR(true)}
            >
              Show QR Code
            </button>
          </div>
        ) : (
          <div className="qris-display">
            <div className="qr-code-container">
              <img 
                src={generateQRCodeURL(paymentData.qr_code)}
                alt="QRIS Payment QR Code"
                className="qr-code-image"
              />
            </div>
            
            <div className="qris-instructions">
              <h4>Payment Instructions:</h4>
              <ol>
                <li>Open your mobile banking or e-wallet app</li>
                <li>Select "Scan QR" or "QRIS" menu</li>
                <li>Point camera at the QR code above</li>
                <li>Confirm payment amount of Rp {paymentData.amount?.toLocaleString('id-ID')}</li>
                <li>Wait for payment confirmation</li>
              </ol>
            </div>

            <div className="qris-actions">
              <button 
                className="btn-secondary"
                onClick={() => setShowQR(false)}
              >
                Hide QR
              </button>
              
              {/* Test Mode Simulation Button */}
              {paymentData.is_test_mode && (
                <button 
                  className="btn-test simulate-btn"
                  onClick={handleSimulatePayment}
                  disabled={simulating}
                >
                  {simulating ? 'Processing...' : 'üß™ Simulate Payment (Test)'}
                </button>
              )}
            </div>

            <div className="payment-info">
              <p className="amount">Total: Rp {paymentData.amount?.toLocaleString('id-ID')}</p>
              <p className="booking-ref">Ref: {bookingData.booking_number}</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default QRISPayment;
```

## üîß STEP 5: SUCCESS PAGE COMPONENT

### File: src/components/booking/PaymentSuccess.jsx (new)
```jsx
import React from 'react';

const PaymentSuccess = ({ bookingData, onNewBooking }) => {
  return (
    <div className="payment-success">
      <div className="success-content">
        <div className="success-icon">
          <span className="checkmark">‚úÖ</span>
        </div>
        
        <h2>Payment Successful!</h2>
        <p>Your booking has been confirmed</p>
        
        <div className="booking-details">
          <h3>Booking Details</h3>
          <div className="detail-item">
            <span>Booking Number:</span>
            <span className="booking-number">{bookingData.booking_number}</span>
          </div>
          <div className="detail-item">
            <span>Status:</span>
            <span className="status-confirmed">Confirmed</span>
          </div>
          <div className="detail-item">
            <span>Total Paid:</span>
            <span>Rp {bookingData.total_price?.toLocaleString('id-ID')}</span>
          </div>
        </div>
        
        <div className="next-steps">
          <h4>Next Steps:</h4>
          <ul>
            <li>üìß Confirmation email has been sent</li>
            <li>üì± Save booking number for reference</li>
            <li>üè† Arrive according to check-in schedule</li>
          </ul>
        </div>
        
        <div className="action-buttons">
          <button 
            className="btn-primary"
            onClick={onNewBooking}
          >
            Book Again
          </button>
          
          <button 
            className="btn-secondary"
            onClick={() => window.print()}
          >
            Print Confirmation
          </button>
        </div>
      </div>
    </div>
  );
};

export default PaymentSuccess;
```

## üé® STEP 6: CSS STYLES

### File: src/styles/payment.css (new)
```css
/* Payment Flow Styles */
.booking-flow-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
}

.payment-page {
  min-height: 100vh;
  background-color: #f5f5f5;
}

.payment-header {
  display: flex;
  align-items: center;
  padding: 20px;
  background: white;
  border-bottom: 1px solid #eee;
}

.back-button {
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  margin-right: 10px;
}

.payment-content {
  padding: 20px;
}

.booking-summary {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.total-amount {
  font-weight: bold;
  color: #e74c3c;
  font-size: 18px;
}

.payment-timer {
  text-align: center;
  color: #f39c12;
  font-weight: bold;
  margin-top: 10px;
}

.payment-status {
  text-align: center;
  margin-bottom: 20px;
}

.status-pending {
  color: #f39c12;
  font-size: 18px;
}

.status-completed {
  color: #27ae60;
  font-size: 18px;
  font-weight: bold;
}

.status-icon {
  margin-right: 8px;
}

/* QRIS Styles */
.qris-payment {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
}

.qris-header {
  text-align: center;
  margin-bottom: 20px;
}

.payment-methods {
  margin-bottom: 20px;
}

.method-icons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.method {
  background: #f8f9fa;
  padding: 10px;
  border-radius: 5px;
  text-align: center;
}

.show-qr-btn {
  width: 100%;
  padding: 15px;
  font-size: 16px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.qr-code-container {
  text-align: center;
  margin-bottom: 20px;
}

.qr-code-image {
  max-width: 300px;
  width: 100%;
  border: 2px solid #ddd;
  border-radius: 8px;
}

.qris-instructions {
  margin-bottom: 20px;
}

.qris-instructions ol {
  padding-left: 20px;
}

.qris-instructions li {
  margin-bottom: 8px;
}

.qris-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-bottom: 20px;
}

.btn-secondary {
  padding: 10px 20px;
  background: #95a5a6;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.btn-test {
  padding: 10px 20px;
  background: #e67e22;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.payment-info {
  text-align: center;
  border-top: 1px solid #eee;
  padding-top: 15px;
}

.amount {
  font-size: 18px;
  font-weight: bold;
  color: #e74c3c;
}

.booking-ref {
  color: #7f8c8d;
  font-size: 14px;
}

/* Success Page Styles */
.payment-success {
  text-align: center;
  padding: 40px 20px;
  background: white;
  border-radius: 8px;
}

.success-icon .checkmark {
  font-size: 64px;
  color: #27ae60;
}

.booking-details {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
}

.booking-number {
  font-weight: bold;
  color: #3498db;
}

.status-confirmed {
  color: #27ae60;
  font-weight: bold;
}

.next-steps {
  text-align: left;
  margin: 20px 0;
}

.next-steps ul {
  list-style: none;
  padding: 0;
}

.next-steps li {
  margin-bottom: 8px;
}

.action-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 30px;
}

.test-mode-notice {
  background: #fff3cd;
  color: #856404;
  padding: 10px;
  border-radius: 5px;
  margin-top: 20px;
  text-align: center;
}

/* Responsive */
@media (max-width: 768px) {
  .qris-actions {
    flex-direction: column;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .qr-code-image {
    max-width: 250px;
  }
}
```

## üì± STEP 7: HOW TO IMPLEMENT

### 1. **Replace your current booking button:**
```jsx
// OLD (in your current component):
<button onClick={handleCompleteBooking}>Complete Booking</button>

// NEW:
<BookingFlow roomData={room} homestayData={homestay} />
```

### 2. **Add to your main App.js:**
```jsx
import './styles/payment.css';
```

### 3. **Test the complete flow:**
1. Fill booking form ‚Üí Click "Lanjut ke Pembayaran"
2. See payment page with QR code
3. Click "üß™ Simulasi Pembayaran (Test)" button
4. See success page with confirmation

### 4. **With real Xendit credentials:**
- Remove simulate button
- QR codes will work with real Indonesian banking apps
- Webhooks will automatically confirm payments

## üöÄ USAGE FLOW

```
User Journey:
1. Guest fills booking form
2. Clicks "Continue to Payment"
3. Sees payment page with booking summary
4. Clicks "Show QR Code"
5. Scans QR with Indonesian banking app
6. Payment auto-confirmed
7. Sees success page
```

## üß™ TESTING CHECKLIST

- [ ] Booking form submits correctly
- [ ] Payment page displays QR code
- [ ] Simulate button works in test mode
- [ ] Payment status updates automatically
- [ ] Success page shows booking details
- [ ] Back button works on payment page
- [ ] Timer counts down correctly
- [ ] Mobile responsive design

This complete implementation transforms your simple booking into a full Indonesian QRIS payment system! üáÆüá©üí≥ 